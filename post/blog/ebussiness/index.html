	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.15" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> 一个电商网站的基本实现 &middot; jsmeta </title>
  
  <link rel="stylesheet" href="https://jiangshanmeta.github.io/css/index.css">
  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

</head>

	<body class=" article-body">
		<nav class="article-nav">
			<a href="https://jiangshanmeta.github.io/">Home</a>
			<a href="https://jiangshanmeta.github.io/demo/index.html">前端作品</a>
			<a href="https://jiangshanmeta.github.io/categories/index.html">日志分类</a>
		</nav>
		<div class="article ">
			<div >
			  <h1 class="text-center">一个电商网站的基本实现</h1>
			  <p >Tue, Jul 5, 2016</p>
			      <p>最近在做的是一个简易的购物系统，因为并不是主营业务，所以并不像电商网站那样复杂，否则就我一个人做这件事情会崩溃的。虽然只是一个简易版的电商，但是各项功能还是有的。有商品的展示列表，商品的详情展示，购物车功能，订单功能，金流管理。其中支付功能和金流我要处理的并不多，只是在以往基础上添加几个参数写几个if else。其他的就要一个一个慢慢写。</p>

<p>第一个要实现的是商品的本身。</p>

<p>关于这些商品，一开始我们是线上部分只做纯展示使用，线下负责具体的业务，所以这个商品表的结构并不困难，一个名称，一段描述，一张图，一个价格范围，这些都是很简单的东西，比较复杂的是商品的分类，于是我们又建了一个商品分类表，商品表里保存着商品分类表里的一个id。这个商品分类表其实不复杂，一个名称，再加上一个enum的基础分类即可，其余字段都是小的辅助。有了商品做商品列表和商品详情页就没什么难的了，就是个纯展示的工作。因为种类本身就不多，连搜索都没加。第一阶段的工作就这样结束了，也没有后面这个小型电商网站什么事。</p>

<p>后来，后来就开始做了呗。首先要做的是补充商品信息。原来只有一个简单的商品描述，但是型号、颜色之类的都没有去添加。针对这个问题，本来是想和淘宝似的做个正交的分类。然后老板直接说就做一级分类。这数据上的复杂度就直接下来了。一个商品对应多个型号，每个型号有自己的价格，与淘宝不同的是，我们线下有多家实体店，所以每个型号需要对应多个库存。一般来说这种多型号的应该建张商品型号表然后关联起来，然而本来为了偷懒我就建了个array然后多个型号都扔到这个这个array里。最终的后台编辑这个型号是用vue做的。深深感觉我在这里留了的坑。希望后人重构的时候能够淡定。其实还有个坑，是我在数据库的最终保存形式是json而不是一个array。我已经遇到一个坑了。自己挖的坑，含着泪也要踩下去。</p>

<p>商品的必要信息有了，然后是购物车的实现。</p>

<p>作为一个穷的只逛淘宝的人，其他的电商网站我还真的不熟悉。淘宝最近实在推app，对于购物车功能要求登录。然而传统的电商是不要求登陆的。于是我们需要本地存储。我们使用的本地存储方案是localStorage。之所以采用这个方案一个很重要的方案是因为同事也在用它做本地存储，当然，从纯技术角度来看localStorage比cookie好用，而且作为移动端项目也不用太过于担心兼容性问题。</p>

<p>然后是购物车的数据结构。一开始有两个大的方向，一个是在用户本身建一个购物车字段存具体信息，因为我们使用的是mongoDB数据库，可以存一个array，另一个方案是拆一张表出来。于是我就问头其他电商的思路，头说考虑性能还是建张表吧。表的结构不复杂，用户的id，用户基本信息的快照，商品的id，商品型号，商品基本信息快照，商品数量，加入时间。最后一个我是见有的电商购物车保存多少天然后就删掉而预留的字段，目前并没有用到。用户每次想购物车加入商品，就会插入一条记录。</p>

<p>数据结构约定好了就要实现同步了。其实我的做法是比较投机取巧的，如果是非登录态，添加商品的时候只会快照一些基本信息存到localStorage里，但是如果是在登录态，向购物里添加东西是需要ajax请求的，后端插入数据后返回的数据包含这个购物车记录的id，我就利用有没有这个id判断数据库是否已插入这条数据。遍历post过来的本地数据，如果没购物车id就直接插入一条新的记录，如果有这个id就update一下（可能会修改数量，本身我只支持修改数量，并不支持修改型号），一些安全校验就不说了。但是上面的实现有个问题，一开始我也没有想到，就是一条购物车记录线上有数据，但是用户在非登录态删除了，同步的时候上面的方法并无法识别。我的解决方案是 在处理post过来的数据之前先拿到此时线上购物车的ids 存成一个array（这个时间点很重要），然后处理post过来的数据，把post过来的数据库id也存成一个array，两者比较如果线上有post过来的没有，就说明本地删了数据，要把线上数据也删除。</p>

<p>其他的就是些增删查改之类的工作了，没什么太大的难度，就是注意同步数据这个问题，顺便感谢vue。</p>

<p>购物车实现完成之后就是从购物车到订单了。</p>

<p>从购物车到订单这一步牵扯到的表比较多。购物车表、商品表、订单表，还有一个子订单表。购物车表就不用说了，商品表是因为要查一遍最新的商品信息，拿到最新的价格等信息，用户选中的购物车中的每一条记录都会转化成子订单中的一条记录，同时在订单表中更新。订单表除了子订单这一个字段外，还有一些用户的基本信息，状态、各种时间戳。</p>

<p>从购物车生成订单后，还需要用户确认。因为业务的需要，有些商品虽然是线上卖，但是要到线下实体店处理（我不会告诉你处理这个写了不少代码），还有有的商品可以邮寄，就有了满多少钱包邮的问题。所以需要用户确认取货方式、去哪家店处理、最终支付金额。在这里用户可以选择删除部分子订单，或者把一些订单里的商品重新放回购物车，或者把订单彻底取消。前两个处理的时候需要考虑订单中商品价格的重新计算、顺带着还有是否达到包邮价格。</p>

<p>后来同事吐槽我说你见过哪个电商有放回购物车这个功能的？于是我就念了两句诗。不要在乎这些细节，反正我实现了。</p>

<p>用户确认订单后后进入支付环节。此时，用户依然可以取消订单。支付是用的同事封装好的代码，虽然我也改了几行，毕竟同事写的代码考虑的都是主营业务订单，我们这个小电商系统实际是自己写着玩的。在支付成功的回调函数中，我更新了订单的状态，写入了金流信息。</p>

<p>现在用户已付款，剩下的就是门店获取订单信息，准备货，就是一些基本的增删查改。</p>

<p>这个小电商基本上是实现了，但是我的主要工作是实现功能，也就是把js和php写完，换句话说就是样式完全没理，根本没法看。看看是让美术设计一套还是抄一套别的电商的样式。</p>

<p>基本就这样。写了差不多一个星期，完活，撒花。</p>

<p>然后就遇到坑了。在商品分类那里，原来是要考虑多家门店多个库存的，后来老板说这样维护起来压力过大，让我在商品分类那里存一个配件id，把这个当成一个配件，然后在库存表里查库存信息。其实写起来并没有什么问题，多查一次表而已。</p>

<p>update 2016/08/02</p>

<p>其实这个小电商功能一直没怎么用起来，今天又小修小补了，做了一个直接购买功能。其实是同事闲先加入购物车再购买是在太折腾，让我仿照其他电商网站做一个直接购买功能。仅仅从功能实现角度来看这个问题其实并不复杂，但是我发现我上面预言有坑的地方确实坑到了自己。每次的匹配规格做的太纠结了，当初真的该建一张新表。然而后悔也晚了，数据已经填进去了，现在改就太折腾了，所以还是想着法补救吧。其实现在想做的是把这个规格匹配封装到Model层中，至少不用每次复制粘贴规格匹配了。而且有了<a href="http://jiangshanmeta.github.io/post/php/exit/">封装差错检测</a>的经验这个也做起来很容易，匹配成功就返回必要的数据，匹配不成功就直接报错退出程序。</p>

			</div>


		</div>
		<script>
console.log("联系我吧   540118044@qq.com");
</script>   
  </body>
</html>
